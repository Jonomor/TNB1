name: Generate Blog Post with Market Context

on:
  schedule:
    - cron: '0 10 * * 1,3,5'
  workflow_dispatch:

jobs:
  generate-and-post:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Create Script File
        run: |
          cat > generate-post.cjs << 'ENDOFSCRIPT'
          const https = require('https');
          const fs = require('fs');

          function httpsRequest(url, options = {}) {
            return new Promise((resolve, reject) => {
              const urlObj = new URL(url);
              const requestOptions = {
                hostname: urlObj.hostname,
                path: urlObj.pathname + urlObj.search,
                method: options.method || 'GET',
                headers: {
                  'User-Agent': 'The-Neutral-Bridge-Blog/1.0',
                  ...(options.headers || {})
                }
              };

              const req = https.request(requestOptions, (res) => {
                let data = '';
                res.on('data', chunk => { data += chunk; });
                res.on('end', () => {
                  try {
                    const parsed = JSON.parse(data);
                    // Check for API-level errors (like 404 or 400)
                    if (res.statusCode >= 400) {
                      reject(new Error(`API Error (${res.statusCode}): ${JSON.stringify(parsed)}`));
                    } else {
                      resolve(parsed);
                    }
                  } catch (e) {
                    reject(new Error('Parse error: ' + data.substring(0, 200)));
                  }
                });
              });

              req.on('error', reject);
              if (options.body) req.write(options.body);
              req.end();
            });
          }

          async function run() {
            try {
              console.log('Fetching XRP data...');
              const apiKey = process.env.COINGECKO_API_KEY || '';
              const apiUrl = 'https://api.coingecko.com/api/v3/coins/ripple?localization=false&tickers=false&community_data=false&developer_data=false' + (apiKey ? '&x_cg_demo_api_key=' + apiKey : '');
              
              const coinData = await httpsRequest(apiUrl);
              
              if (!coinData.market_data) {
                throw new Error('No market data in response');
              }

              const p = coinData.market_data.current_price.usd;
              const c = coinData.market_data.price_change_percentage_24h;
              const c7d = coinData.market_data.price_change_percentage_7d;
              const m = coinData.market_data.market_cap.usd;
              const v = coinData.market_data.total_volume.usd;
              const rank = coinData.market_cap_rank;
              const today = new Date().toISOString().split('T')[0];

              console.log('Data received. Price:', p);

              const promptText = 'You are K. Morgan writing for The Neutral Bridge. Create a forensic technical analysis matching this EXACT structure:\n\n' +
                'MARKET DATA (' + today + '):\n' +
                '- XRP: $' + p.toFixed(4) + ' (' + (c > 0 ? '+' : '') + c.toFixed(2) + '% 24h, ' + (c7d > 0 ? '+' : '') + c7d.toFixed(2) + '% 7d)\n' +
                '- Market Cap: $' + (m/1e9).toFixed(2) + 'B (Rank #' + rank + ')\n' +
                '- 24h Volume: $' + (v/1e9).toFixed(2) + 'B\n\n' +
                'REQUIRED STRUCTURE:\n\n' +
                '**Forensic Abstract**\n' +
                '[50 words. Clinical summary: "A technical post-mortem of [specific price level/event]. Dissecting the divergence between [retail behavior] and [institutional utility]. Explore why [current situation] is a structural requirement for [larger thesis]."]\n\n' +
                '## Executive Summary: [Compelling Title]\n' +
                '[200 words. Answer-first format:\n' +
                '- Para 1: Current market dislocation - price vs utility divergence\n' +
                '- Para 2: Technical breakdown as capitulation event, not failure\n' +
                '- Para 3: Why XRP remains definitive for global settlement despite volatility]\n\n' +
                '## Deep Dive: Anatomy of [Current Technical Situation]\n\n' +
                '### The $X.XX Support Level Explained\n' +
                '[150 words. Technical precision:\n' +
                '- What this price level represents structurally\n' +
                '- RSI, Fibonacci retracement, liquidity analysis\n' +
                '- Algorithmic trading bot behavior at this level]\n\n' +
                '### Historical Echo: [Previous Bear Cycle]\n' +
                '[150 words. Include DIRECT QUOTE from credible source:\n' +
                '"[Exact quote from CoinMarketCap/CoinDesk/Bloomberg]" - Source Name\n' +
                'Then analyze what this means for current situation.]\n\n' +
                '## The Neutral Bridge: Utility in the Face of Volatility\n\n' +
                '### 1. Settlement Finality vs. Speculation\n' +
                '[200 words. Contrast:\n' +
                '- What traders care about vs what institutions care about\n' +
                '- XRPL ledger close time (3-5 seconds) with absolute finality\n' +
                '- Lower volatility preferred by ODL partners\n' +
                '- How price drops lower barrier to entry for institutions]\n\n' +
                '### 2. The RLUSD Liquidity Injection\n' +
                '[200 words. Technical infrastructure:\n' +
                '- AMM environment mechanics\n' +
                '- Arbitrage opportunities in XRP/RLUSD pools\n' +
                '- Algorithmic buy pressure from rebalancing\n' +
                '- Distinction from speculative support]\n\n' +
                '### 3. Nostro/Vostro Account Elimination\n' +
                '[150 words. Global capital efficiency:\n' +
                '- Trillions trapped in pre-funded accounts\n' +
                '- XRP deflationary burn mechanics\n' +
                '- Paradox: lower price = higher volume = faster burn rate]\n\n' +
                '## Regulatory Clarity and Strategic Integration\n' +
                '[200 words. Legal moat analysis:\n' +
                '- Evolution from "regulation by enforcement" to "strategic integration"\n' +
                '- XRP unique legal clarity in US\n' +
                '- Banks execute on certainty, not price action\n' +
                '- Potential retail shakeout before institutional integration announcements]\n\n' +
                '## Outlook: The Path Forward\n\n' +
                '**Scenario A (The Flush):**\n' +
                '[100 words. Bear case with specific price targets and macro triggers]\n\n' +
                '**Scenario B (The Reversal):**\n' +
                '[100 words. Bull case with technical confirmation levels]\n\n' +
                '## Conclusion\n' +
                '[75 words. Tie back to Neutral Bridge thesis. "Mathematics and necessity" over hype. Focus on migration to most efficient rail.]\n\n' +
                'CRITICAL REQUIREMENTS:\n' +
                '- Temperature: 0.3 (clinical precision)\n' +
                '- Use exact technical terms: "liquidity wall", "momentum exhaustion", "capitulation event", "structural requirement"\n' +
                '- Include at least ONE credible quote (attribute to CoinMarketCap, CoinDesk, or Bloomberg analysis)\n' +
                '- Binary scenario analysis (Scenario A/B)\n' +
                '- No marketing language - forensic tone throughout\n' +
                '- Target 1400-1600 words\n' +
                '- Write for institutional risk committees';

          console.log('Calling Gemini 2.5 Flash...');
              
              
              const geminiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=' + process.env.GEMINI_API_KEY;
              
              const geminiData = await httpsRequest(geminiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  system_instruction: {
                    parts: [{ text: "You are a senior systems engineer and financial forensic analyst for 'The Neutral Bridge'. Your tone is clinical, technical, and objective. Avoid hype, marketing adjectives, or price predictions. Focus on architectural throughput and ledger health." }]
                  },
                  contents: [{ 
                  role: "user",
                  parts: [{ text: promptText }] }],
                  generationConfig: { 
                    temperature: 0.4, 
                    maxOutputTokens: 2048 
                  }
                })
              });

              if (!geminiData.candidates || !geminiData.candidates[0]) {
                throw new Error('Gemini failed to generate content. Check logs.');
              }

              const content = geminiData.candidates[0].content.parts[0].text;
              const today = new Date().toISOString().split('T')[0];
              
              const markdown = `---\ntitle: "XRP Systemic Analysis - ${today}"\ndate: ${today}\nauthor: "The Neutral Bridge"\ntags: ["XRP", "XRPL", "Infrastructure"]\n---\n\n${content}\n`;

              const folder = './blog_posts';
              if (!fs.existsSync(folder)) {
                fs.mkdirSync(folder, { recursive: true });
              }
              
              fs.writeFileSync(`${folder}/market-analysis-${today}.md`, markdown);
              console.log('Success! File created.');
              
            } catch (err) {
              console.error('Error Details:', err.message);
              process.exit(1);
            }
          }

          run();
          ENDOFSCRIPT

      - name: Run Script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          COINGECKO_API_KEY: ${{ secrets.COINGECKO_API_KEY }}
        run: node generate-post.cjs

      - name: Commit and Push
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add blog_posts/
          git commit -m "Auto-generate blog post $(date +'%Y-%m-%d')" || echo "No changes"
          git push
