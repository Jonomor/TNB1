name: Generate Blog Post with Market Context

on:
  schedule:
    - cron: '0 10 * * 1,3,5'
  workflow_dispatch:

jobs:
  generate-and-post:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Create Script File
        run: |
          cat > generate-post.cjs << 'ENDOFSCRIPT'
          const https = require('https');
          const fs = require('fs');

          function httpsRequest(url, options = {}) {
            return new Promise((resolve, reject) => {
              const urlObj = new URL(url);
              const requestOptions = {
                hostname: urlObj.hostname,
                path: urlObj.pathname + urlObj.search,
                method: options.method || 'GET',
                headers: {
                  'User-Agent': 'The-Neutral-Bridge-Blog/1.0',
                  ...(options.headers || {})
                }
              };

              const req = https.request(requestOptions, (res) => {
                let data = '';
                res.on('data', chunk => { data += chunk; });
                res.on('end', () => {
                  try {
                    const parsed = JSON.parse(data);
                    if (res.statusCode >= 400) {
                      reject(new Error(`API Error (${res.statusCode}): ${JSON.stringify(parsed)}`));
                    } else {
                      resolve(parsed);
                    }
                  } catch (e) {
                    reject(new Error('Parse error: ' + data.substring(0, 200)));
                  }
                });
              });

              req.on('error', reject);
              if (options.body) req.write(options.body);
              req.end();
            });
          }

          async function run() {
            try {
              console.log('Fetching XRP data...');
              const apiKey = process.env.COINGECKO_API_KEY || '';
              const apiUrl = 'https://api.coingecko.com/api/v3/coins/ripple?localization=false&tickers=false&community_data=false&developer_data=false' + (apiKey ? '&x_cg_demo_api_key=' + apiKey : '');
              
              const coinData = await httpsRequest(apiUrl);
              
              if (!coinData.market_data) {
                throw new Error('No market data in response');
              }

              const p = coinData.market_data.current_price.usd;
              const c = coinData.market_data.price_change_percentage_24h;
              const c7d = coinData.market_data.price_change_percentage_7d;
              const m = coinData.market_data.market_cap.usd;
              const v = coinData.market_data.total_volume.usd;
              const rank = coinData.market_cap_rank;

              console.log('Data received. Price:', p);

              const promptText = `You are writing for The Neutral Bridge, an institutional-grade financial analysis publication. Generate a forensic analysis post with SEO optimization.

CURRENT MARKET DATA:
- XRP Price: $${p.toFixed(4)}
- 24h Change: ${c.toFixed(2)}%
- 7d Change: ${c7d.toFixed(2)}%
- Market Cap: $${(m/1e9).toFixed(2)}B (Rank #${rank})
- 24h Volume: $${(v/1e9).toFixed(2)}B

REQUIRED STRUCTURE (use exact markdown headers):

## Executive Summary
[150 words max. Answer-first format for AI snippet extraction. Structure: Problem → Current Reality → Market Impact. Zero speculation. Clinical tone.]

## Macro Context: Global Payment Infrastructure
[300 words. Connect price movement to broader financial system developments:
- ISO 20022 migration timeline
- Central bank digital currency pilots
- Cross-border payment modernization
- Traditional correspondent banking limitations
Frame XRP within larger infrastructure transformation.]

## Technical Analysis: XRPL Mechanics
[400 words. Forensic deep dive:
- Current ledger throughput (transactions per second)
- Validator consensus health metrics
- On-chain settlement finality vs traditional T+2
- DEX liquidity depth and market microstructure
- Network fee dynamics
Use precise technical specifications. Reference actual XRPL documentation.]

## Institutional Consideration: Treasury Perspective
[250 words. Position XRP as infrastructure tool:
- Settlement efficiency: 3-5 seconds vs 3-5 days
- Regulatory clarity (SEC litigation status, international frameworks)
- Enterprise adoption signals (RippleNet activity, payment corridor depth)
- Risk management for corporate treasury operations
- Volatility management in cross-border flows]

## Forward Outlook: 30-90 Day Infrastructure Roadmap
[100 words. Evidence-based analysis:
- Scheduled XRPL protocol upgrades
- Regulatory calendar events (court decisions, policy announcements)
- Payment corridor expansion timelines
- Market structure evolution
NO price predictions. Focus on infrastructure readiness and systemic catalysts.]

---

CRITICAL REQUIREMENTS:
- Tone: Bloomberg Terminal meets Systems Engineering whitepaper
- NO marketing language, NO hype, NO price targets
- Use entity linking: "XRP Ledger (XRPL)", "Ripple Labs", "ISO 20022 standard"
- Include specific metrics, ledger statistics, protocol specifications
- Write for institutional risk committees and sovereign wealth funds
- Target 1200-1400 words total`;

              console.log('Calling Gemini 2.5 Flash...');
              
              const geminiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=' + process.env.GEMINI_API_KEY;
              
              const geminiData = await httpsRequest(geminiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  system_instruction: {
                    parts: [{ text: "You are K. Morgan, systems analyst and author of The Neutral Bridge. You analyze XRP and Ripple infrastructure with forensic precision for institutional audiences. Your analysis is authoritative, data-driven, and devoid of speculation. You position XRP as financial plumbing infrastructure, not a speculative asset. Write for institutional risk committees, sovereign wealth funds, and treasury operations teams." }]
                  },
                  contents: [{ 
                  role: "user",
                  parts: [{ text: promptText }] }],
                  generationConfig: { 
                    temperature: 0.3, 
                    maxOutputTokens: 3000,
                    topP: 0.8,
                    topK: 40
                  }
                })
              });

              if (!geminiData.candidates || !geminiData.candidates[0]) {
                throw new Error('Gemini failed to generate content. Check logs.');
              }

              const content = geminiData.candidates[0].content.parts[0].text;
              const today = new Date().toISOString().split('T')[0];
              
              const frontmatter = `---
title: "XRP Infrastructure Analysis – ${today}"
date: ${today}
author: "K. Morgan"
category: "XRPL Technical Analysis"
tags: ["XRP", "XRPL", "Payment Infrastructure", "ISO 20022", "Cross-Border Settlement"]
excerpt: "Forensic analysis of XRP Ledger mechanics, institutional settlement implications, and payment infrastructure evolution."
---

`;
              
              const markdown = frontmatter + content + '\n';

              const folder = './blog_posts';
              if (!fs.existsSync(folder)) {
                fs.mkdirSync(folder, { recursive: true });
              }
              
              fs.writeFileSync(`${folder}/xrpl-analysis-${today}.md`, markdown);
              console.log('Success! SEO-optimized forensic analysis created.');
              
            } catch (err) {
              console.error('Error Details:', err.message);
              process.exit(1);
            }
          }

          run();
          ENDOFSCRIPT

      - name: Run Script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          COINGECKO_API_KEY: ${{ secrets.COINGECKO_API_KEY }}
        run: node generate-post.cjs

      - name: Commit and Push
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add blog_posts/
          git commit -m "Auto-generate forensic analysis $(date +'%Y-%m-%d')" || echo "No changes"
          git push
