name: Generate Blog Post with Market Context

on:
  schedule:
    - cron: '0 10 * * 1,3,5'
  workflow_dispatch:

jobs:
  generate-and-post:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Fetch Market Data and Generate Post
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          COINGECKO_API_KEY: ${{ secrets.COINGECKO_API_KEY }}
        run: |
          cat > generate-post.cjs << 'SCRIPT_EOF'
          const https = require('https');
          const fs = require('fs');

          function fetch(url, options = {}) {
            return new Promise((resolve, reject) => {
              const urlObj = new URL(url);
              const requestOptions = {
                hostname: urlObj.hostname,
                path: urlObj.pathname + urlObj.search,
                method: options.method || 'GET',
                headers: options.headers || {}
              };

              const req = https.request(requestOptions, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  try {
                    resolve(JSON.parse(data));
                  } catch (e) {
                    reject(new Error('Failed to parse JSON: ' + data.substring(0, 200)));
                  }
                });
              });

              req.on('error', reject);
              if (options.body) req.write(options.body);
              req.end();
            });
          }

          async function generatePost() {
            try {
              console.log('Fetching market data...');
              const coingeckoKey = process.env.COINGECKO_API_KEY || '';
              const priceUrl = coingeckoKey 
                ? 'https://api.coingecko.com/api/v3/coins/ripple?localization=false&tickers=false&community_data=false&developer_data=false&x_cg_demo_api_key=' + coingeckoKey
                : 'https://api.coingecko.com/api/v3/coins/ripple?localization=false&tickers=false&community_data=false&developer_data=false';
              
              console.log('API URL:', priceUrl.replace(coingeckoKey, 'HIDDEN'));
              
              const priceData = await fetch(priceUrl);
              console.log('Received data, checking structure...');
              
              if (!priceData || !priceData.market_data) {
                throw new Error('Invalid API response structure. Response: ' + JSON.stringify(priceData).substring(0, 500));
              }

              const price = priceData.market_data.current_price.usd;
              const change24h = priceData.market_data.price_change_percentage_24h;
              const marketCap = priceData.market_data.market_cap.usd;
              const volume = priceData.market_data.total_volume.usd;

              console.log('Market data retrieved successfully');
              console.log('Price:', price, 'Change:', change24h);

              const prompt = 'CURRENT MARKET DATA:\n' +
                'XRP Price: $' + price.toFixed(4) + '\n' +
                '24h Change: ' + (change24h > 0 ? '+' : '') + change24h.toFixed(2) + '%\n' +
                'Market Cap: $' + (marketCap / 1e9).toFixed(2) + 'B\n' +
                'Volume: $' + (volume / 1e9).toFixed(2) + 'B\n\n' +
                'Write a 600-800 word technical analysis for The Neutral Bridge blog. Focus on XRP Ledger infrastructure and systemic implications. Maintain forensic, engineering tone. Avoid price predictions. Include concrete technical details.';

              console.log('Calling Gemini API...');
              
              const geminiResponse = await fetch(
                'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=' + process.env.GEMINI_API_KEY,
                {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.7, maxOutputTokens: 1024 }
                  })
                }
              );

              if (!geminiResponse || !geminiResponse.candidates || !geminiResponse.candidates[0]) {
                throw new Error('Invalid Gemini API response');
              }

              const content = geminiResponse.candidates[0].content.parts[0].text;
              const date = new Date().toISOString().split('T')[0];
              
              const post = '---\n' +
                'title: "XRP Market Analysis - ' + date + '"\n' +
                'date: ' + date + '\n' +
                'author: "The Neutral Bridge"\n' +
                'tags: ["XRP", "Market Analysis"]\n' +
                '---\n\n' +
                content +
                '\n';

              const dir = './blog_posts';
              if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
              fs.writeFileSync(dir + '/market-analysis-' + date + '.md', post);
              console.log('Post generated successfully at:', dir + '/market-analysis-' + date + '.md');
            } catch (error) {
              console.error('Error details:', error.message);
              console.error('Stack:', error.stack);
              process.exit(1);
            }
          }

          generatePost();
          SCRIPT_EOF

          node generate-post.cjs

      - name: Commit and Push
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add blog_posts/
          git commit -m "Auto-generate market analysis [$(date +'%Y-%m-%d')]" || echo "No changes"
          git push
