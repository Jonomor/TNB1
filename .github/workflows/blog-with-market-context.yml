name: Generate Blog Post with Market Context

on:
  schedule:
    - cron: '0 10 * * 1,3,5'
  workflow_dispatch:

jobs:
  generate-and-post:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Create Script File
        run: |
          cat > generate-post.cjs << 'ENDOFSCRIPT'
          const https = require('https');
          const fs = require('fs');

          function httpsRequest(url, options = {}) {
            return new Promise((resolve, reject) => {
              const urlObj = new URL(url);
              const requestOptions = {
                hostname: urlObj.hostname,
                path: urlObj.pathname + urlObj.search,
                method: options.method || 'GET',
                headers: {
                  'User-Agent': 'The-Neutral-Bridge-Blog/1.0',
                  ...(options.headers || {})
                }
              };

              const req = https.request(requestOptions, (res) => {
                let data = '';
                res.on('data', chunk => { data += chunk; });
                res.on('end', () => {
                  try {
                    const parsed = JSON.parse(data);
                    // Check for API-level errors (like 404 or 400)
                    if (res.statusCode >= 400) {
                      reject(new Error(`API Error (${res.statusCode}): ${JSON.stringify(parsed)}`));
                    } else {
                      resolve(parsed);
                    }
                  } catch (e) {
                    reject(new Error('Parse error: ' + data.substring(0, 200)));
                  }
                });
              });

              req.on('error', reject);
              if (options.body) req.write(options.body);
              req.end();
            });
          }

          async function run() {
            try {
              console.log('Fetching XRP data...');
              const apiKey = process.env.COINGECKO_API_KEY || '';
              const apiUrl = 'https://api.coingecko.com/api/v3/coins/ripple?localization=false&tickers=false&community_data=false&developer_data=false' + (apiKey ? '&x_cg_demo_api_key=' + apiKey : '');
              
              const coinData = await httpsRequest(apiUrl);
              
              if (!coinData.market_data) {
                throw new Error('No market data in response');
              }

              const p = coinData.market_data.current_price.usd;
              const c = coinData.market_data.price_change_percentage_24h;
              const m = coinData.market_data.market_cap.usd;
              const v = coinData.market_data.total_volume.usd;

              console.log('Data received. Price:', p);

              const promptText = `Current XRP market data: Price $${p.toFixed(4)}, 24h change ${c.toFixed(2)}%, Market cap $${(m/1e9).toFixed(2)}B, Volume $${(v/1e9).toFixed(2)}B. Write a technical analysis focusing on XRP infrastructure and systemic implications. Focus on the XRPL ledger mechanics.`;

              console.log('Calling Gemini v1beta...');
              
              // Using v1beta and the versioned model name for stability
              const geminiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=' + process.env.GEMINI_API_KEY;
              
              const geminiData = await httpsRequest(geminiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  system_instruction: {
                    parts: [{ text: "You are a senior systems engineer and financial forensic analyst for 'The Neutral Bridge'. Your tone is clinical, technical, and objective. Avoid hype, marketing adjectives, or price predictions. Focus on architectural throughput and ledger health." }]
                  },
                  contents: [{ parts: [{ text: promptText }] }],
                  generationConfig: { 
                    temperature: 0.4, 
                    maxOutputTokens: 2048 
                  }
                })
              });

              if (!geminiData.candidates || !geminiData.candidates[0]) {
                throw new Error('Gemini failed to generate content. Check logs.');
              }

              const content = geminiData.candidates[0].content.parts[0].text;
              const today = new Date().toISOString().split('T')[0];
              
              const markdown = `---\ntitle: "XRP Systemic Analysis - ${today}"\ndate: ${today}\nauthor: "The Neutral Bridge"\ntags: ["XRP", "XRPL", "Infrastructure"]\n---\n\n${content}\n`;

              const folder = './blog_posts';
              if (!fs.existsSync(folder)) {
                fs.mkdirSync(folder, { recursive: true });
              }
              
              fs.writeFileSync(`${folder}/market-analysis-${today}.md`, markdown);
              console.log('Success! File created.');
              
            } catch (err) {
              console.error('Error Details:', err.message);
              process.exit(1);
            }
          }

          run();
          ENDOFSCRIPT

      - name: Run Script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          COINGECKO_API_KEY: ${{ secrets.COINGECKO_API_KEY }}
        run: node generate-post.cjs

      - name: Commit and Push
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add blog_posts/
          git commit -m "Auto-generate blog post $(date +'%Y-%m-%d')" || echo "No changes"
          git push
